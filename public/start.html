<!-- start.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Start Avalon Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h2>Game Settings</h2>
        <form id="game-form">
            <label for="num-players">Total Players (5–10):
                <input type="number" id="num-players" min="5" max="10" value="5" required>
            </label>
            <label for="num-ai">AI Players:
                <input type="number" id="num-ai" min="0" max="9" value="0" required>
            </label>
            <div class="role-list">
                <label><input type="checkbox" name="roles" value="Merlin" checked> Merlin</label>
                <label><input type="checkbox" name="roles" value="Assassin" checked> Assassin</label>
                <label><input type="checkbox" name="roles" value="Percival" checked> Percival</label>
                <label><input type="checkbox" name="roles" value="Morgana" checked> Morgana</label>
                <label><input type="checkbox" name="roles" value="Mordred"> Mordred</label>
                <label><input type="checkbox" name="roles" value="Oberon"> Oberon</label>
                <label>
                    Loyal Servant:
                    <input type="number" id="loyal-servant-count" name="loyal-servant-count" min="0" max="5" value="1"
                        style="width: 30px;">
                </label>
                <label>
                    Minion:
                    <input type="number" id="minion-count" name="minion-count" min="0" max="3" value="0"
                        style="width: 30px;">
                </label>
            </div>
            <label for="custom-game-id">
                GameID (optional, max 10 chars):
                <input type="text" id="custom-game-id" maxlength="10" placeholder="Leave blank for random">
                <span class="hint">You can enter a custom GameID (max 10 characters). If left blank, a random
                    6-character GameID will be generated.</span>
            </label>

            <button type="submit" id="start-btn">Start the Game</button>
            <button type="button" class="discard" id="discard-btn">Discard</button>
            <div class="error" id="game-error"></div>
            <div class="info" id="game-info"></div>
        </form>
    </div>
    <script type="module">

        // Import 'db' (your Firestore instance) from the firebase-config.js file
        import { db } from './firebase-config.js';
        // Also import the specific Firestore functions you need
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { nameStorageDocId, nameStorageState } from './utils.js';


        // Check admin login
        if (!sessionStorage.getItem('admin_name')) {
            location.href = 'login.html';
        }
        const form = document.getElementById('game-form');
        const errorDiv = document.getElementById('game-error');
        const infoDiv = document.getElementById('game-info');
        const startBtn = document.getElementById('start-btn');
        const discardBtn = document.getElementById('discard-btn');
        const numPlayersInput = document.getElementById('num-players');
        const numAIInput = document.getElementById('num-ai');

        // Update max AI when total players changes
        numPlayersInput.addEventListener('input', () => {
            const maxAI = Math.max(0, parseInt(numPlayersInput.value, 10) - 1);
            numAIInput.max = maxAI;
            if (parseInt(numAIInput.value, 10) > maxAI) {
                numAIInput.value = maxAI;
            }
        });

        // Copy to clipboard function
        function copyToClipboard(text, iconElem) {
            navigator.clipboard.writeText(text).then(() => {
                // Show "Copied!" message
                let copiedMsg = document.createElement('span');
                copiedMsg.className = 'copied-msg';
                copiedMsg.textContent = 'Copied!';
                iconElem.parentNode.appendChild(copiedMsg);
                setTimeout(() => {
                    if (copiedMsg.parentNode) copiedMsg.parentNode.removeChild(copiedMsg);
                }, 1200);
            });
        }

        discardBtn.onclick = () => {
            window.location.href = 'admin.html';
        };
        startBtn.onclick = () => {
            sessionStorage.setItem('username', sessionStorage.getItem('admin_name'));
            window.location.href = `game.html?gameId=${encodeURIComponent(gameId)}`;
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            errorDiv.textContent = '';
            infoDiv.textContent = '';
            const numPlayers = parseInt(document.getElementById('num-players').value, 10);
            const numAI = parseInt(document.getElementById('num-ai').value, 10);

            // Get checked roles
            const roleCheckboxes = document.querySelectorAll('input[name="roles"]:checked');
            let rolesObj = {};
            roleCheckboxes.forEach(cb => {
                rolesObj[cb.value] = 1;
            });
            let roles = Array.from(roleCheckboxes).map(cb => cb.value);

            // Get Loyal Servant and Minion counts
            const loyalServantCount = parseInt(document.getElementById('loyal-servant-count').value, 10);
            const minionCount = parseInt(document.getElementById('minion-count').value, 10);

            // Add Loyal Servant and Minion counts
            if (loyalServantCount > 0) {
                rolesObj["Loyal Servant"] = loyalServantCount;
            }
            if (minionCount > 0) {
                rolesObj["Minion"] = minionCount;
            }

            // Validate total roles
            const totalRoles = Object.values(rolesObj).reduce((a, b) => a + b, 0);
            if (totalRoles !== numPlayers) {
                errorDiv.textContent = `Total roles (${totalRoles}) must equal number of players (${numPlayers}).`;
                return;
            }

            if (numPlayers < 5 || numPlayers > 10) {
                errorDiv.textContent = "Players must be 5–10.";
                return;
            }
            if (numAI < 0 || numAI > numPlayers - 1) {
                errorDiv.textContent = "AI players must be between 0 and total players.";
                return;
            }
            const aiPlayers = Array.from({ length: numAI }, (_, i) => `AI ${i + 1}`);
            // Use custom GameID if provided, else generate a random 6-character GameID.
            const customGameId = document.getElementById('custom-game-id').value.trim();
            let gameCode;
            if (customGameId) {
                if (customGameId.length > 10) {
                    errorDiv.textContent = "GameID must be 10 characters or less. Use a random ID instead.";
                } else {
                    gameCode = customGameId;
                }
            }
            if (!gameCode) {
                gameCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            }
            try {
                const docRef = await addDoc(collection(db, "games"), {
                    game_id: gameCode,
                    admin_id: sessionStorage.getItem('admin_name'),
                    created_at: serverTimestamp(),
                    status: "lobby",
                    num_players: numPlayers,
                    roles: rolesObj,
                    players: aiPlayers,
                    assignments: {},
                });
                sessionStorage.setItem(nameStorageDocId(gameCode), docRef.id);

                let secondsLeft = 5;
                infoDiv.innerHTML = `
                    Game created!<br>
                    <div class="game-id-row">
                    Game ID: <b id="game-id">${gameCode}</b><br>
                    <svg id="copy-icon" class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <rect x="9" y="9" width="13" height="13" rx="2" fill="currentColor" opacity="0.5"/>
                        <rect x="3" y="3" width="13" height="13" rx="2" fill="currentColor"/>
                    </svg>
                    </div>
                    Redirecting to the homepage in <span id="countdown">${secondsLeft}</span> seconds...
                    `;
                form.reset();

                // Copy icon event
                const copyIcon = document.getElementById('copy-icon');
                const gameIdElem = document.getElementById('game-id');
                copyIcon.addEventListener('click', function () {
                    copyToClipboard(gameIdElem.textContent, copyIcon);
                });

                // Countdown
                const countdownElem = document.getElementById('countdown');
                const interval = setInterval(() => {
                    secondsLeft--;
                    countdownElem.textContent = secondsLeft;
                    if (secondsLeft <= 0) {
                        clearInterval(interval);
                        location.href = 'index.html';
                    }
                }, 1000);

            } catch (err) {
                errorDiv.textContent = err.message;
                console.error("Error adding document: ", err);
                alert("Failed to add item. Check console for details.");
            }
        };
    </script>
</body>

</html>