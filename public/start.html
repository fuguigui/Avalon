<!-- start.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Start Avalon Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { font-family: sans-serif; background: #222; color: #eee; }
    .container { max-width: 500px; margin: 5em auto; background: #333; padding: 2em; border-radius: 12px; }
    label { display: block; margin-top: 1em; }
    input[type="number"] { width: 80px; padding: 0.5em; border-radius: 4px; border: 1px solid #555; background: #222; color: #eee; }
    .role-list { margin-top: 1em; }
    .role-list label { display: inline-block; margin-right: 1em; }
    button { margin: 1em 1em 0 0; padding: 0.7em 2em; font-size: 1.1em; border: none; border-radius: 6px; background: #4caf50; color: #fff; cursor: pointer; }
    button.discard { background: #ff5252; }
    button:hover { background: #388e3c; }
    button.discard:hover { background: #c62828; }
    .error { color: #ff5252; margin-top: 1em; }
    .info { color: #b2ff59; margin-top: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Game Settings</h2>
    <form id="game-form">
      <label for="num-players">Total Players (6–10):</label>
      <input type="number" id="num-players" min="6" max="10" value="5" required>

      <label for="num-ai">AI Players:</label>
      <input type="number" id="num-ai" min="0" max="9" value="0" required>

      <div class="role-list">
        <label><input type="checkbox" name="roles" value="Merlin" checked> Merlin</label>
        <label><input type="checkbox" name="roles" value="Assassin" checked> Assassin</label>
        <label><input type="checkbox" name="roles" value="Percival" checked> Percival</label>
        <label><input type="checkbox" name="roles" value="Morgana" checked> Morgana</label>
        <label><input type="checkbox" name="roles" value="Mordred"> Mordred</label>
        <label><input type="checkbox" name="roles" value="Oberon"> Oberon</label>
        <label><input type="checkbox" name="roles" value="Loyal Servant" checked> Loyal Servant</label>
        <label><input type="checkbox" name="roles" value="Minion"> Minion</label>
      </div>

      <button type="submit" id="start-btn">Start the Game</button>
      <button type="button" class="discard" id="discard-btn">Discard</button>
      <div class="error" id="game-error"></div>
      <div class="info" id="game-info"></div>
    </form>
  </div>
  <script>
    // Check admin login
    if (!localStorage.getItem('avalon_admin_name')) {
      location.href = 'login.html';
    }
    const form = document.getElementById('game-form');
    const errorDiv = document.getElementById('game-error');
    const infoDiv = document.getElementById('game-info');
    const discardBtn = document.getElementById('discard-btn');
    const numPlayersInput = document.getElementById('num-players');
    const numAIInput = document.getElementById('num-ai');

    // Update max AI when total players changes
    numPlayersInput.addEventListener('input', () => {
      const maxAI = Math.max(0, parseInt(numPlayersInput.value, 10) - 1);
      numAIInput.max = maxAI;
      if (parseInt(numAIInput.value, 10) > maxAI) {
        numAIInput.value = maxAI;
      }
    });

    form.onsubmit = async (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      infoDiv.textContent = '';
      const numPlayers = parseInt(document.getElementById('num-players').value, 10);
      const numAI = parseInt(document.getElementById('num-ai').value, 10);
      const roleCheckboxes = document.querySelectorAll('input[name="roles"]:checked');
      const roles = Array.from(roleCheckboxes).map(cb => cb.value);
      if (numPlayers < 6 || numPlayers > 10) {
        errorDiv.textContent = "Players must be 5–10.";
        return;
      }
      if (numAI < 0 || numAI > numPlayers - 1) {
        errorDiv.textContent = "AI players must be between 0 and total players.";
        return;
      }
      if (roles.length < numPlayers) {
        errorDiv.textContent = "Not enough roles selected for all players.";
        return;
      }
      // Generate a game code
      const gameCode = Math.random().toString(36).substr(2, 6).toUpperCase();
      // Create game in Firestore
      try {
        await db.collection('games').add({
          admin: localStorage.getItem('avalon_admin_name'),
          gameCode,
          numPlayers,
          numAI,
          roles,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          state: 'waiting',
          players: [],
          assignments: {},
          quest: null,
          votes: [],
        });
        infoDiv.textContent = `Game created! Game Code: ${gameCode}`;
        form.reset();
      } catch (err) {
        errorDiv.textContent = err.message;
      }
    };
    discardBtn.onclick = () => {
      form.reset();
      errorDiv.textContent = '';
      infoDiv.textContent = '';
    };
  </script>
</body>
</html>
