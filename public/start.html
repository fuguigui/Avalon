<!-- start.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Start Avalon Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script type="module" src="firebase-config.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h2>Game Settings</h2>
        <form id="game-form">
            <label for="num-players">Total Players (6–10):</label>
            <input type="number" id="num-players" min="6" max="10" value="6" required>

            <label for="num-ai">AI Players:</label>
            <input type="number" id="num-ai" min="0" max="9" value="0" required>

            <div class="role-list">
                <label><input type="checkbox" name="roles" value="Merlin" checked> Merlin</label>
                <label><input type="checkbox" name="roles" value="Assassin" checked> Assassin</label>
                <label><input type="checkbox" name="roles" value="Percival" checked> Percival</label>
                <label><input type="checkbox" name="roles" value="Morgana" checked> Morgana</label>
                <label><input type="checkbox" name="roles" value="Mordred"> Mordred</label>
                <label><input type="checkbox" name="roles" value="Oberon"> Oberon</label>
                <label><input type="checkbox" name="roles" value="Loyal Servant" checked> Loyal Servant</label>
                <label><input type="checkbox" name="roles" value="Minion"> Minion</label>
            </div>

            <button type="submit" id="start-btn">Start the Game</button>
            <button type="button" class="discard" id="discard-btn">Discard</button>
            <div class="error" id="game-error"></div>
            <div class="info" id="game-info"></div>
        </form>
    </div>
    <script type="module">

        // Import 'db' (your Firestore instance) from the firebase-config.js file
        import { db } from './firebase-config.js';
        // Also import the specific Firestore functions you need
        import { collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


        // Check admin login
        if (!localStorage.getItem('avalon_admin_name')) {
            location.href = 'login.html';
        }
        const form = document.getElementById('game-form');
        const errorDiv = document.getElementById('game-error');
        const infoDiv = document.getElementById('game-info');
        const discardBtn = document.getElementById('discard-btn');
        const numPlayersInput = document.getElementById('num-players');
        const numAIInput = document.getElementById('num-ai');

        // Update max AI when total players changes
        numPlayersInput.addEventListener('input', () => {
            const maxAI = Math.max(0, parseInt(numPlayersInput.value, 10) - 1);
            numAIInput.max = maxAI;
            if (parseInt(numAIInput.value, 10) > maxAI) {
                numAIInput.value = maxAI;
            }
        });

        // Copy to clipboard function
        function copyToClipboard(text, iconElem) {
            navigator.clipboard.writeText(text).then(() => {
                // Show "Copied!" message
                let copiedMsg = document.createElement('span');
                copiedMsg.className = 'copied-msg';
                copiedMsg.textContent = 'Copied!';
                iconElem.parentNode.appendChild(copiedMsg);
                setTimeout(() => {
                    if (copiedMsg.parentNode) copiedMsg.parentNode.removeChild(copiedMsg);
                }, 1200);
            });
        }

        discardBtn.onclick = () => {
            window.location.href = 'admin.html';
        };

        form.onsubmit = async (e) => {
            e.preventDefault();
            errorDiv.textContent = '';
            infoDiv.textContent = '';
            const numPlayers = parseInt(document.getElementById('num-players').value, 10);
            const numAI = parseInt(document.getElementById('num-ai').value, 10);
            const roleCheckboxes = document.querySelectorAll('input[name="roles"]:checked');
            const roles = Array.from(roleCheckboxes).map(cb => cb.value);
            if (numPlayers < 6 || numPlayers > 10) {
                errorDiv.textContent = "Players must be 6–10.";
                return;
            }
            if (numAI < 0 || numAI > numPlayers - 1) {
                errorDiv.textContent = "AI players must be between 0 and total players.";
                return;
            }
            if (roles.length > numPlayers) {
                errorDiv.textContent = "Too many roles selected for all players.";
                return;
            }
            // Generate a game code
            const gameCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            // Create game in Firestore
            try {
                // Use the 'db' instance imported from firebase-config.js
                const docRef = await addDoc(collection(db, "games"), {
                    game_id: gameCode,
                    admin_id: localStorage.getItem('avalon_admin_name'),
                    created_at: serverTimestamp(),
                    state: "waiting",
                    num_players: numPlayers,
                    num_ai: numAI,
                    roles: roles,
                    players: [],
                    assignments: {},
                });
                localStorage.setItem('avalon_game_id', docRef.id);

                let secondsLeft = 5;
                infoDiv.innerHTML = `
          Game created!<br>
          <div class="game-id-row">
          Game ID: <b id="game-id">${gameCode}</b><br>
          <svg id="copy-icon" class="copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <rect x="9" y="9" width="13" height="13" rx="2" fill="currentColor" opacity="0.5"/>
            <rect x="3" y="3" width="13" height="13" rx="2" fill="currentColor"/>
          </svg>
          </div>
          Redirecting to the game lobby in <span id="countdown">${secondsLeft}</span> seconds...
        `;
                form.reset();

                // Copy icon event
                const copyIcon = document.getElementById('copy-icon');
                const gameIdElem = document.getElementById('game-id');
                copyIcon.addEventListener('click', function () {
                    copyToClipboard(gameIdElem.textContent, copyIcon);
                });

                // Countdown
                const countdownElem = document.getElementById('countdown');
                const interval = setInterval(() => {
                    secondsLeft--;
                    countdownElem.textContent = secondsLeft;
                    if (secondsLeft <= 0) {
                        clearInterval(interval);
                        location.href = 'index.html';
                    }
                }, 1000);

            } catch (err) {
                errorDiv.textContent = err.message;
                console.error("Error adding document: ", err);
                alert("Failed to add item. Check console for details.");
            }
        };
    </script>
</body>

</html>